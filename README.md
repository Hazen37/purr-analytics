# Purr Analytics ‚Äî ETL + Analytics –¥–ª—è Ozon

–ü—Ä–æ–µ–∫—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏, —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö Ozon:

* –∑–∞–∫–∞–∑—ã (Seller API, FBO),
* —Ñ–∏–Ω–∞–Ω—Å—ã –∏ –∫–æ–º–∏—Å—Å–∏–∏,
* —Ä–µ–∫–ª–∞–º–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏ (Performance API),
* –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –¥–ª—è –¥–∞—à–±–æ—Ä–¥–æ–≤ (Metabase).

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –≤–æ–∫—Ä—É–≥ **–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ–≥–æ ETL**, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–æ cron / scheduler.

---

## üì¶ –°–æ—Å—Ç–∞–≤ –ø—Ä–æ–µ–∫—Ç–∞

```
purr-analytics/
‚îú‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ .gitignore
‚îÇ
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ cli/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ update_all.py        # –ì–ª–∞–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ ETL
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py            # ENV / –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ db.py                # –†–∞–±–æ—Ç–∞ —Å PostgreSQL
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ migrations/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ run.py               # –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ etl/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ orders/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ load_orders.py   # –ó–∞–∫–∞–∑—ã + –∫–ª–∏–µ–Ω—Ç—ã + profit
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ finance/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ finance_api.py   # –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (Seller Finance API)
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ period_costs.py  # –ê–≥—Ä–µ–≥–∞—Ü–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ performance/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ campaigns.py     # –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ daily.py         # –î–Ω–µ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–∞–º–ø–∞–Ω–∏–π
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ orders.py        # –ê—Ç—Ä–∏–±—É—Ü–∏—è –∑–∞–∫–∞–∑–æ–≤ –∫ —Ä–µ–∫–ª–∞–º–µ
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ catalog/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ product_catalog.py  # SKU ‚Üí –∞—Ç—Ä–∏–±—É—Ç—ã (–≤–∫—É—Å, –≥—Ä–∞–º–º—ã)
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ ozon/
‚îÇ       ‚îî‚îÄ‚îÄ seller_api.py       # –ö–ª–∏–µ–Ω—Ç—ã Ozon API
‚îÇ
‚îî‚îÄ‚îÄ deploy/
    ‚îî‚îÄ‚îÄ initdb/                 # (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) SQL –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
```

---

## üß† –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –ø—Ä–∏–Ω—Ü–∏–ø—ã

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

* **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**
  –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫ ETL –Ω–µ –¥–æ–ª–∂–µ–Ω:

  * –ø–ª–æ–¥–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã,
  * –ª–æ–º–∞—Ç—å –∞–≥—Ä–µ–≥–∞—Ç—ã,
  * —Ç—Ä–µ–±–æ–≤–∞—Ç—å –æ—á–∏—Å—Ç–∫–∏ –ë–î.

* **Lookback window**
  ETL –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ `N` –¥–Ω–µ–π (`ETL_LOOKBACK_DAYS`) ‚Äî —ç—Ç–æ:

  * –ª–æ–≤–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤,
  * –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç —Ñ–∏–Ω–∞–Ω—Å—ã,
  * –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç ‚Äú–ø—Ä–æ–ø–∞–≤—à–∏–µ‚Äù –∑–∞–∫–∞–∑—ã.

* **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö**

  * `orders`, `order_items` ‚Äî —Ñ–∞–∫—Ç—ã –∑–∞–∫–∞–∑–æ–≤
  * `order_fee_items` ‚Äî –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–∏—Å—Å–∏–π (—Ä–∞–∑–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏)
  * `perf_campaigns` ‚Äî —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∫–∞–º–ø–∞–Ω–∏–π
  * `performance_campaign_daily` ‚Äî –¥–Ω–µ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  * `finance_period_costs` ‚Äî –∞–≥—Ä–µ–≥–∞—Ç—ã –¥–ª—è –¥–∞—à–±–æ—Ä–¥–æ–≤

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ü–æ–¥–Ω—è—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É

```bash
docker compose up -d
```

–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:

* `purr_postgres` ‚Äî PostgreSQL
* `purr_metabase` ‚Äî Metabase (–¥–∞—à–±–æ—Ä–¥—ã)
* `purr_etl_cron` ‚Äî ETL-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

---

### 2. –ü—Ä–æ–≥–Ω–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
docker exec -it purr_etl_cron sh -lc "python -m src.migrations.run"
```

–ú–∏–≥—Ä–∞—Ü–∏–∏:

* **–±–µ–∑ –≤–µ—Ä—Å–∏–π**
* –±–µ–∑–æ–ø–∞—Å–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å—Ç–∞—Ä—Ç–µ
* `CREATE TABLE IF NOT EXISTS`
* `ALTER TABLE ADD COLUMN IF NOT EXISTS`

---

### 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å ETL –≤—Ä—É—á–Ω—É—é

```bash
docker exec -it purr_etl_cron sh -lc "ETL_LOOKBACK_DAYS=30 python -m src.cli.update_all"
```

–ò–ª–∏ —Å —è–≤–Ω—ã–º –¥–∏–∞–ø–∞–∑–æ–Ω–æ–º:

```bash
docker exec -it purr_etl_cron sh -lc "python -m src.cli.update_all 2025-10-01 2025-12-31"
```

---

## ‚öôÔ∏è update_all.py ‚Äî –ø–∞–π–ø–ª–∞–π–Ω ETL

–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —à–∞–≥–æ–≤:

1. **–ú–∏–≥—Ä–∞—Ü–∏–∏**
2. **–ó–∞–∫–∞–∑—ã (Seller API)**

   * UPSERT orders
   * order_items / products
   * –∫–ª–∏–µ–Ω—Ç—ã
   * profit / fees
3. **–§–∏–Ω–∞–Ω—Å—ã (Seller Finance API)**

   * order_fee_items (`uid` + UPSERT)
4. **–ü–µ—Ä–∏–æ–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã**
5. **Performance (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)**

   * –∫–∞–º–ø–∞–Ω–∏–∏
   * –¥–Ω–µ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
   * –∞—Ç—Ä–∏–±—É—Ü–∏—è –∑–∞–∫–∞–∑–æ–≤

### ENV-—Ñ–ª–∞–≥–∏

```bash
ETL_LOOKBACK_DAYS=30

ETL_ENABLE_PERFORMANCE=1
ETL_ENABLE_PERF_CAMPAIGNS=1
ETL_ENABLE_PERF_DAILY=1
ETL_ENABLE_PERF_ORDERS=1

ETL_STRICT_MODE=1   # –ø–∞–¥–∞—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
```

---

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (–∫–ª—é—á–µ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã)

### orders

* –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–∫—Ç –∑–∞–∫–∞–∑–æ–≤
* —Å—Ç–∞—Ç—É—Å, –≤—ã—Ä—É—á–∫–∞, profit
* —Ñ–ª–∞–≥–∏ `ozon_missing`

### order_fee_items

* –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–∏—Å—Å–∏–π
* `uid` ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ–≥–æ UPSERT
* `source`: `posting_financial`, `finance_api`

### performance_campaign_daily

* PRIMARY KEY `(campaign_id, stat_date)`
* –¥–Ω–µ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ–∫–ª–∞–º—ã

### finance_period_costs

* –∞–≥—Ä–µ–≥–∞—Ç—ã —Ä–∞—Å—Ö–æ–¥–æ–≤ –¥–ª—è –¥–∞—à–±–æ—Ä–¥–æ–≤
* PRIMARY KEY `(cost_date, fee_group, fee_name)`

---

## üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ Metabase

Metabase –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ `purr_postgres`.

–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏:

* –≤—Å–µ–≥–¥–∞ —Ñ–∏–ª—å—Ç—Ä `order_date`
* –Ω–µ–¥–µ–ª—å–Ω—ã–µ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ `date_trunc('week', ...)`
* trim –Ω—É–ª–µ–≤—ã—Ö –Ω–µ–¥–µ–ª—å —Å–ø—Ä–∞–≤–∞

---

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ ETL

### –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

```sql
SELECT COUNT(*) FROM order_fee_items WHERE source='finance_api';
```

### –î–∞—Ç—ã

```sql
SELECT MIN(order_date), MAX(order_date) FROM orders;
```

### Performance

```sql
SELECT stat_date, SUM(spend)
FROM performance_campaign_daily
GROUP BY 1
ORDER BY 1 DESC;
```

---

## üõ†Ô∏è –û—Ç–ª–∞–¥–∫–∞

–õ–æ–≥–∏:

```bash
docker logs -f purr_etl_cron
```

Postgres:

```bash
docker exec -it purr_postgres psql -U postgres -d purr
```

---

## üß≠ –î–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è (TODO)

* healthcheck CLI
* bulk inserts (COPY)
* incremental finance API
* –∞–ª–µ—Ä—Ç—ã –≤ Telegram
* data tests (row counts / freshness)
